<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üå§Ô∏è Advanced Weather App</title>

  <!-- Fonts and Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078ff">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      height: 100vh;
      font-family: 'Poppins', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s ease-in-out;
    }

    .container {
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px 25px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }

    .search-box {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }

    input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px 0 0 8px;
      outline: none;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 0 8px 8px 0;
      background: #0078ff;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    button:hover {
      background: #005fcc;
    }

    .location-btn {
      display: block;
      width: 100%;
      background: #00c853;
      border-radius: 8px;
      margin-top: 8px;
      transition: background 0.3s;
    }

    .location-btn:hover {
      background: #009624;
    }

    .weather-info {
      margin-top: 25px;
      transition: 0.3s;
      text-transform: capitalize;
    }

    .weather-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 10px;
    }

    .weather-info h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .weather-info p {
      margin: 5px 0;
      font-size: 16px;
    }

    .error {
      color: #ffb3b3;
      font-size: 14px;
    }

    #installBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #0078ff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    #installBtn:hover {
      background: #005fcc;
    }

    @media (max-width: 480px) {
      h1 { font-size: 22px; }
      .container { padding: 20px; }
      input, button { font-size: 13px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üå¶Ô∏è Advanced Weather App</h1>
    <div class="search-box">
      <input type="text" id="cityInput" placeholder="Enter city name">
      <button id="searchBtn">Search</button>
    </div>

    <button id="locationBtn" class="location-btn">üìç Use My Location</button>

    <div class="weather-info" id="weatherInfo">
      <p>Enter a city name or use your location to see the weather.</p>
    </div>
  </div>

  <button id="installBtn">‚¨áÔ∏è Install App</button>

 <script>
  const apiKey = "3cae54db50e538875c8d7eaca5dbeb30";
  const searchBtn = document.getElementById("searchBtn");
  const cityInput = document.getElementById("cityInput");
  const locationBtn = document.getElementById("locationBtn");
  const weatherInfo = document.getElementById("weatherInfo");

  searchBtn.addEventListener("click", () => {
    const city = cityInput.value.trim();
    if (city) getWeatherByCity(city);
  });

  locationBtn.addEventListener("click", getLiveLocationWeather);

  // üîç City-based search
  function getWeatherByCity(city) {
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;
    fetchWeather(url);
  }

  // ‚úÖ Fixed Live GPS Location with real-time updates + fallback
  function getLiveLocationWeather() {
    if (!("geolocation" in navigator)) {
      console.warn("No GPS support, using IP fallback");
      return fallbackToIP();
    }

    weatherInfo.innerHTML = `<p>üì° Getting your live location...</p>`;

    // watchPosition gives real-time updates and no cache
    const watchID = navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        console.log(`üìç Live GPS: ${latitude}, ${longitude}`);
        fetchWeatherByCoords(latitude, longitude);
      },
      (err) => {
        console.warn("GPS failed, using IP fallback:", err.message);
        fallbackToIP();
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );

    // Stop watching after 2 updates to save battery
    setTimeout(() => navigator.geolocation.clearWatch(watchID), 15000);
  }

  // üåê IP fallback
  function fallbackToIP() {
    fetch("https://ipapi.co/json/")
      .then((res) => res.json())
      .then((data) => {
        if (data.latitude && data.longitude) {
          fetchWeatherByCoords(data.latitude, data.longitude);
        } else {
          weatherInfo.innerHTML = `<p class="error">Unable to detect location.</p>`;
        }
      })
      .catch(() => {
        weatherInfo.innerHTML = `<p class="error">Location detection failed.</p>`;
      });
  }

  // üõ∞Ô∏è Fetch by coordinates
  function fetchWeatherByCoords(lat, lon) {
    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`;
    fetchWeather(url);
  }

  // ‚òÅÔ∏è Fetch and display
  function fetchWeather(url) {
    fetch(url)
      .then((res) => {
        if (!res.ok) throw new Error("City not found");
        return res.json();
      })
      .then((data) => displayWeather(data))
      .catch((err) => (weatherInfo.innerHTML = `<p class="error">${err.message}</p>`));
  }

  function displayWeather(data) {
    const { name, sys, main, weather, wind } = data;
    const desc = weather[0].description;
    const temp = main.temp.toFixed(1);
    const humidity = main.humidity;
    const windSpeed = wind.speed;
    const iconHTML = getWeatherIcon(weather[0].main.toLowerCase());

    weatherInfo.innerHTML = `
      <div class="weather-icon">${iconHTML}</div>
      <h2>${name}, ${sys.country}</h2>
      <p>${desc}</p>
      <p>üå°Ô∏è ${temp}¬∞C</p>
      <p>üíß Humidity: ${humidity}%</p>
      <p>üí® Wind: ${windSpeed} m/s</p>
    `;

    changeBackground(sys.country);
  }

  function getWeatherIcon(condition) {
    switch (condition) {
      case "clear": return `<i data-lucide="sun"></i>`;
      case "clouds": return `<i data-lucide="cloud"></i>`;
      case "rain": return `<i data-lucide="cloud-rain"></i>`;
      case "thunderstorm": return `<i data-lucide="cloud-lightning"></i>`;
      case "snow": return `<i data-lucide="snowflake"></i>`;
      case "mist":
      case "fog": return `<i data-lucide="cloud-fog"></i>`;
      default: return `<i data-lucide="cloud-drizzle"></i>`;
    }
  }

  function changeBackground(countryCode) {
    const backgrounds = {
      US: "https://images.unsplash.com/photo-1503264116251-35a269479413",
      IN: "https://images.unsplash.com/photo-1524492412937-b28074a5d7da",
      GB: "https://images.unsplash.com/photo-1505761671935-60b3a7427bad",
      FR: "https://images.unsplash.com/photo-1522098543979-ffc7f79d57d5",
      JP: "https://images.unsplash.com/photo-1526483360412-f4dbaf036963",
      BR: "https://images.unsplash.com/photo-1519681393784-d120267933ba",
      CA: "https://images.unsplash.com/photo-1519681393784-d120267933ba",
      AU: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
      AE: "https://images.unsplash.com/photo-1571407970349-bc81e11edb6a",
      default: "https://images.unsplash.com/photo-1506744038136-46273834b3fb"
    };
    const bgUrl = backgrounds[countryCode] || backgrounds.default;
    document.body.style.backgroundImage = `url('${bgUrl}?auto=format&fit=crop&w=1600&q=80')`;
    lucide.createIcons();
  }

  // Lucide icons init
  lucide.createIcons();

  // PWA install setup
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("Service Worker Registered"));
  }

  let deferredPrompt;
  const installBtn = document.getElementById("installBtn");

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = "block";
  });

  installBtn.addEventListener("click", async () => {
    installBtn.style.display = "none";
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response: ${outcome}`);
    deferredPrompt = null;
  });

  window.addEventListener("appinstalled", () => {
    console.log("App Installed!");
  });
</script>

</body>
</html>
