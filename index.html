
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üå§Ô∏è Advanced Weather Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ‚úÖ PWA manifest link added -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2a5298">

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:'Poppins',sans-serif;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg,#1e3c72,#2a5298);
    padding:16px;
    transition:background 0.6s ease;
  }

  .weather-app{
    width:100%;
    max-width:420px;
    background:rgba(0,0,0,0.28);
    backdrop-filter:blur(12px);
    border-radius:18px;
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.35);
    overflow-y:auto;
    max-height:92vh;
  }

  .search{display:flex;gap:8px;align-items:center;position:sticky;top:8px;background:transparent;padding-bottom:8px;z-index:10}
  .search input{flex:1;padding:10px;border-radius:10px;border:none;outline:none;background:rgba(255,255,255,0.04);color:#fff}
  .search button{padding:10px 12px;border-radius:10px;border:none;background:#2f80ed;color:#fff;cursor:pointer;font-weight:600}

  .main-info{text-align:center;margin-top:8px}
  .main-info h1{font-size:56px;margin-bottom:4px}
  .main-info p{font-size:15px;opacity:0.95;margin:2px 0}

  canvas{margin-top:12px;border-radius:10px}

  .stats{
    margin-top:16px;
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:10px;
  }
  .stats div{
    background:rgba(255,255,255,0.04);
    padding:10px;border-radius:10px;text-align:center;font-size:14px;
  }
  .stats div span{display:block;opacity:0.85;font-size:12px}

  .forecast-5day{margin-top:16px}
  .forecast-5day h3{text-align:center;margin-bottom:10px;font-size:16px}
  .forecast-grid{display:flex;gap:10px;overflow-x:auto;padding-bottom:10px}
  .forecast-grid::-webkit-scrollbar{height:8px}
  .forecast-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:6px}
  .forecast-card{
    background:rgba(255,255,255,0.03);
    min-width:86px;
    flex-shrink:0;
    border-radius:10px;
    padding:10px;
    text-align:center;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease;
  }
  .forecast-card:hover{transform:translateY(-6px);box-shadow:0 8px 18px rgba(0,0,0,0.4)}

  .alert-box{margin-top:14px;text-align:center;background:rgba(255,255,255,0.04);border-radius:10px;padding:8px;font-weight:600;display:none}

  /* ‚úÖ Floating install button */
  #installBtn{
    position:fixed;
    bottom:20px;
    right:20px;
    background:#2f80ed;
    color:#fff;
    border:none;
    padding:12px 16px;
    border-radius:50px;
    font-weight:600;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    display:none;
    cursor:pointer;
    z-index:999;
  }

  /* Modal */
  .modal-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:9999;
  }
  .modal{
    width:92%;
    max-width:520px;
    background:linear-gradient(180deg, rgba(10,10,12,0.96), rgba(20,20,28,0.96));
    color:#fff;border-radius:14px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,0.6);
    max-height:85vh;overflow:auto;
  }
  .modal .close{
    background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer;float:right;
  }
  .modal h2{margin-top:6px;font-size:20px}
  .modal .modal-current{display:flex;align-items:center;gap:12px;margin-top:6px}
  .modal .modal-current img{width:64px;height:64px}
  .modal .modal-current .temp{font-size:36px;font-weight:700}
  .modal .hourly-list{margin-top:12px;display:flex;flex-direction:column;gap:8px;font-size:14px}
  .hour-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03)}
  .hour-row .condition{display:flex;gap:8px;align-items:center}
  .modal canvas{margin-top:12px}

  @media (max-width:420px){
    .main-info h1{font-size:44px}
    .forecast-card{min-width:78px}
  }
</style>
</head>
<body>
  <div class="weather-app">
    <div class="search">
      <input id="cityInput" placeholder="Enter city name (or allow location)"/>
      <button id="searchBtn">Search</button>
      <button id="locBtn">Use My Location</button>
    </div>

    <div class="main-info">
      <h1 id="temp">--¬∞</h1>
      <p id="condition">---</p>
      <p id="location">---</p>
    </div>

    <canvas id="hourlyChart" height="100"></canvas>

    <div class="stats">
      <div><span>Humidity</span><div id="humidity">--%</div></div>
      <div><span>Pressure</span><div id="pressure">-- hPa</div></div>
      <div><span>Wind</span><div id="wind">-- km/h</div></div>
      <div><span>Feels Like</span><div id="feelslike">--¬∞C</div></div>
      <div><span>Sunrise</span><div id="sunrise">--:--</div></div>
      <div><span>Sunset</span><div id="sunset">--:--</div></div>
      <div><span>Visibility</span><div id="visibility">-- km</div></div>
      <div><span>UV</span><div id="uv">--</div></div>
    </div>

    <div class="forecast-5day">
      <h3>5-Day Forecast</h3>
      <div class="forecast-grid" id="forecastGrid"></div>
    </div>

    <div class="alert-box" id="alertBox">‚ö†Ô∏è Weather Alert!</div>
  </div>

  <!-- ‚úÖ Floating install button -->
  <button id="installBtn">üì≤ Install App</button>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <button class="close" id="modalClose">‚úï</button>
      <h2 id="modalDay">Day</h2>

      <div class="modal-current">
        <img id="modalIcon" src="" alt="icon"/>
        <div>
          <div id="modalLocation" style="opacity:0.95;font-weight:600"></div>
          <div class="temp" id="modalTemp">--¬∞</div>
          <div id="modalCond" style="opacity:0.9;font-size:14px"></div>
        </div>
      </div>

      <canvas id="modalChart" height="120"></canvas>

      <div class="hourly-list" id="hourlyList"></div>
    </div>
  </div>

  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(() => console.log('‚úÖ Service Worker registered'))
      .catch(err => console.log('SW registration failed:', err));
  });
}
</script>

<script>
/* ---------- CONFIG ---------- */
const apiKey = "3cae54db50e538875c8d7eaca5dbeb30"; // kept as in your code
/* ---------------------------- */

const searchBtn = document.getElementById('searchBtn');
const locBtn = document.getElementById('locBtn');
const cityInput = document.getElementById('cityInput');

const tempEl = document.getElementById('temp');
const condEl = document.getElementById('condition');
const locEl = document.getElementById('location');
const humidityEl = document.getElementById('humidity');
const pressureEl = document.getElementById('pressure');
const windEl = document.getElementById('wind');
const feelsEl = document.getElementById('feelslike');
const sunriseEl = document.getElementById('sunrise');
const sunsetEl = document.getElementById('sunset');
const visEl = document.getElementById('visibility');
const uvEl = document.getElementById('uv');
const forecastGrid = document.getElementById('forecastGrid');
const alertBox = document.getElementById('alertBox');

const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const modalDay = document.getElementById('modalDay');
const modalTemp = document.getElementById('modalTemp');
const modalCond = document.getElementById('modalCond');
const modalIcon = document.getElementById('modalIcon');
const modalLocation = document.getElementById('modalLocation');
const hourlyList = document.getElementById('hourlyList');

let hourlyChart, modalChart;
let lastCoords = null;
let watchId = null;
let autoRefreshTimer = null;
let currentWeather = null;   // will hold latest current weather JSON
let currentForecast = null;  // will hold latest 5-day/3h forecast JSON

searchBtn.addEventListener('click', () => {
  const city = cityInput.value.trim();
  if (!city) { alert('Enter a city name or allow location'); return; }
  fetchByCity(city);
});

locBtn.addEventListener('click', () => {
  startGeolocationWatch();
});
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  // Prevent automatic prompt
  e.preventDefault();
  deferredPrompt = e;
  // Show the install button
  installBtn.style.display = 'block';
});

installBtn.addEventListener('click', async () => {
  installBtn.style.display = 'none';
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('User choice:', outcome);
    deferredPrompt = null;
  }
});

window.addEventListener('appinstalled', () => {
  console.log('‚úÖ App installed successfully');
});
/* Modal handlers */
modalClose.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });

function openModal() { modalOverlay.style.display = 'flex'; modalOverlay.setAttribute('aria-hidden','false'); }
function closeModal(){ modalOverlay.style.display = 'none'; modalOverlay.setAttribute('aria-hidden','true'); }

/* ---------- Fetch by city or coords ---------- */
async function fetchByCity(city){
  try{
    const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`);
    const weatherData = await weatherRes.json();
    if (weatherData.cod && weatherData.cod !== 200) { alert('City not found'); return; }
    const { coord } = weatherData;
    await fetchByCoords(coord.lat, coord.lon, weatherData);
  } catch(err){
    console.warn(err);
    alert('Error fetching weather');
  }
}

async function fetchByCoords(lat, lon, providedWeather = null){
  try{
    lastCoords = { lat, lon };
    // fetch current if not provided
    const weatherData = providedWeather ? providedWeather :
      await (await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)).json();

    // 5 day / 3h forecast
    const forecastData = await (await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)).json();

    // onecall for UV (note: free tier returns some data)
    const onecall = await (await fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=minutely&units=metric&appid=${apiKey}`)).json();

    currentWeather = weatherData;
    currentForecast = { forecastData, onecall };

    updateWeatherUI(weatherData, forecastData, onecall);
  } catch(err){
    console.warn('fetchByCoords err', err);
    alert('Error fetching weather by coordinates');
  }
}

/* ---------- UI Update ---------- */
function updateWeatherUI(weatherData, forecastData, onecall){
  // Current
  tempEl.textContent = `${Math.round(weatherData.main.temp)}¬∞`;
  condEl.textContent = weatherData.weather[0].description;
  locEl.textContent = `${weatherData.name}, ${weatherData.sys.country}`;

  humidityEl.textContent = `${weatherData.main.humidity}%`;
  pressureEl.textContent = `${weatherData.main.pressure} hPa`;
  windEl.textContent = `${weatherData.wind.speed} km/h`;
  feelsEl.textContent = `${Math.round(weatherData.main.feels_like)}¬∞C`;
  visEl.textContent = `${(weatherData.visibility / 1000).toFixed(1)} km`;
  sunriseEl.textContent = formatTime(weatherData.sys.sunrise, weatherData.timezone);
  sunsetEl.textContent = formatTime(weatherData.sys.sunset, weatherData.timezone);

  uvEl.textContent = onecall && onecall.current && onecall.current.uvi ? onecall.current.uvi : '‚Äî';

  // background: aesthetic gradient based on main
  const main = weatherData.weather[0].main.toLowerCase();
  setBackground(main);

  // hourly chart (next 8 slots)
  updateHourlyChart(forecastData);

  // forecast grid (daily preview)
  updateForecastGrid(forecastData);
  showAlert(weatherData.weather[0].main);
}

/* ---------- Background ---------- */
function setBackground(main){
  if (main.includes('cloud')) document.body.style.background = 'linear-gradient(135deg,#7b8794,#2b3a4a)';
  else if (main.includes('rain')) document.body.style.background = 'linear-gradient(135deg,#2b4865,#0f2027)';
  else if (main.includes('clear')) document.body.style.background = 'linear-gradient(135deg,#56ccf2,#2f80ed)';
  else if (main.includes('snow')) document.body.style.background = 'linear-gradient(135deg,#83a4d4,#b6fbff)';
  else document.body.style.background = 'linear-gradient(135deg,#1e3c72,#2a5298)';
}

/* ---------- Hourly chart in main UI (next 8 slots) ---------- */
function updateHourlyChart(forecastData){
  const labels = [], temps = [];
  for (let i=0; i<8 && i < forecastData.list.length; i++){
    const dtTxt = forecastData.list[i].dt_txt;
    const h = new Date(dtTxt).getHours();
    labels.push((h<10?'0':'')+h + ':00');
    temps.push(Math.round(forecastData.list[i].main.temp));
  }

  const ctx = document.getElementById('hourlyChart').getContext('2d');
  if (hourlyChart) hourlyChart.destroy();
  hourlyChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ data:temps, borderColor:'#FFD700', tension:0.3, pointRadius:3, fill:false }] },
    options:{ scales:{ y:{ display:false } }, plugins:{ legend:{ display:false } } }
  });
}

/* ---------- Forecast grid (clickable days) ---------- */
function updateForecastGrid(forecastData){
  // forecastData.list contains 3-hour slots. We'll pick one per day by taking the midday slot if possible.
  // Build a map dateStr -> array of slots
  const slotsByDate = {};
  forecastData.list.forEach(slot => {
    const d = new Date(slot.dt * 1000);
    const dateStr = d.toISOString().split('T')[0]; // YYYY-MM-DD
    if (!slotsByDate[dateStr]) slotsByDate[dateStr] = [];
    slotsByDate[dateStr].push(slot);
  });

  // Take up to 5 days from the map keys (ordered)
  const dates = Object.keys(slotsByDate).slice(0, 5);

  forecastGrid.innerHTML = '';
  dates.forEach(dateStr => {
    const daySlots = slotsByDate[dateStr];
    // choose midday slot (12:00) if present, fallback to first
    let representative = daySlots.find(s => new Date(s.dt * 1000).getHours() === 12) || daySlots[0];
    const dayName = new Date(dateStr).toLocaleDateString(undefined, { weekday:'short' });
    const icon = representative.weather[0].icon;
    const temp = Math.round(representative.main.temp);

    const card = document.createElement('div');
    card.className = 'forecast-card';
    card.innerHTML = `<div style="font-size:13px">${dayName}</div>
                      <img src="https://openweathermap.org/img/wn/${icon}.png" width="46" style="display:block;margin:6px auto"/>
                      <div style="font-weight:600">${temp}¬∞C</div>`;
    // on click -> open modal with hourly data for this date
    card.addEventListener('click', () => openDayModal(dateStr, daySlots));
    forecastGrid.appendChild(card);
  });
}

/* ---------- Modal: show hourly details for selected day ---------- */
function openDayModal(dateStr, daySlots){
  // dateStr is YYYY-MM-DD; daySlots is array of 3-hour forecast entries for that day
  modalDay.textContent = new Date(dateStr).toLocaleDateString(undefined, { weekday:'long', month:'short', day:'numeric' });
  // show current live temp & condition for the currently loaded location
  if (currentWeather) {
    modalLocation.textContent = `${currentWeather.name}, ${currentWeather.sys.country}`;
    modalTemp.textContent = `${Math.round(currentWeather.main.temp)}¬∞C`;
    modalCond.textContent = currentWeather.weather[0].description;
    modalIcon.src = `https://openweathermap.org/img/wn/${currentWeather.weather[0].icon}@2x.png`;
  } else {
    modalLocation.textContent = '';
    modalTemp.textContent = '--¬∞';
    modalCond.textContent = '';
    modalIcon.src = '';
  }

  // Build hourly chart data for that day
  const labels = [], temps = [], conditionIcons = [];
  daySlots.forEach(slot => {
    const d = new Date(slot.dt * 1000);
    const hourLabel = (d.getHours()<10?'0':'') + d.getHours() + ':00';
    labels.push(hourLabel);
    temps.push(Math.round(slot.main.temp));
    conditionIcons.push(slot.weather[0].icon);
  });

  // render chart inside modal
  const ctx = document.getElementById('modalChart').getContext('2d');
  if (modalChart) modalChart.destroy();
  modalChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ data:temps, borderColor:'#4ce1b6', tension:0.25, pointRadius:4, fill:false }] },
    options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ display:true, ticks:{ color:'#ddd' }, grid:{ color:'rgba(255,255,255,0.04)' }}, x:{ ticks:{ color:'#ddd' } } }, maintainAspectRatio:false }
  });

  // Build hourly list (time + icon + condition)
  hourlyList.innerHTML = '';
  daySlots.forEach(slot => {
    const d = new Date(slot.dt * 1000);
    const timeStr = (d.getHours()<10?'0':'') + d.getHours() + ':00';
    const condition = slot.weather[0].main;
    const desc = slot.weather[0].description;
    const iconUrl = `https://openweathermap.org/img/wn/${slot.weather[0].icon}.png`;
    const temp = Math.round(slot.main.temp);

    const row = document.createElement('div');
    row.className = 'hour-row';
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
                       <div style="width:50px;font-weight:600">${timeStr}</div>
                       <div class="condition"><img src="${iconUrl}" width="28" alt=""><div style="opacity:0.95">${desc}</div></div>
                     </div>
                     <div style="font-weight:600">${temp}¬∞</div>`;
    hourlyList.appendChild(row);
  });

  openModal();
}

/* ---------- Helper: format time with timezone offset (seconds) ---------- */
function formatTime(unixTs, tzOffsetSeconds){
  // If tzOffsetSeconds is provided (OpenWeather current) convert accordingly
  if (typeof tzOffsetSeconds === 'number') {
    const d = new Date((unixTs + tzOffsetSeconds) * 1000 - (new Date().getTimezoneOffset() * 60000));
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  } else {
    const d = new Date(unixTs * 1000);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
}

/* ---------- Alerts ---------- */
function showAlert(condition){
  if (!condition) { alertBox.style.display='none'; return; }
  if (condition.toLowerCase().includes('rain')) { alertBox.innerText = 'üåßÔ∏è Rain expected! Carry an umbrella.'; alertBox.style.display='block'; }
  else if (condition.toLowerCase().includes('clear')) { alertBox.innerText = '‚òÄÔ∏è Clear skies today!'; alertBox.style.display='block'; }
  else { alertBox.style.display='none'; }
}

/* ---------- Geolocation watch (live updates) ---------- */
function startGeolocationWatch(){
  if (!('geolocation' in navigator)) { alert('Geolocation not supported'); return; }

  // If already watching, do nothing (but still get one immediate fetch)
  if (watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    // fetch weather for new coords
    fetchByCoords(lat, lon);
    // also set lastCoords for periodic refresh
    lastCoords = { lat, lon };
  }, err => {
    console.warn('GPS error', err);
    alert('Location access denied or failed ‚Äî use Search instead');
  }, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });

  // also set up periodic refresh every 5 minutes
  if (autoRefreshTimer) clearInterval(autoRefreshTimer);
  autoRefreshTimer = setInterval(() => {
    if (lastCoords) fetchByCoords(lastCoords.lat, lastCoords.lon);
  }, 300000); // 300000 ms = 5 minutes
}

/* ---------- On load: try to auto-get location, fallback to default city ---------- */
window.addEventListener('load', () => {
  // try to auto-locate once
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      startGeolocationWatch(); // this will fetch and start continuous updates
    }, err => {
      // user denied or fail -> fallback to default city
      fetchByCity('Hyderabad');
    }, { enableHighAccuracy:true, timeout:10000 });
  } else {
    fetchByCity('Hyderabad');
  }
});

</script>
</body>
</html>
